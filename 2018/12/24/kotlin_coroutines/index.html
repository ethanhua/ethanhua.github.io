<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            了解Kotlin协程实现原理这篇就够了 | 
        
        Ethanhua&#39;s blog
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Ethan Hua">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="blog,Kotlin">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/avatar.jpg">
    <link rel="icon" sizes="192x192" href="/img/avatar.jpg">
    <link rel="apple-touch-icon" href="/img/avatar.jpg">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Ethanhua&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="了解Kotlin协程实现原理这篇就够了 | Ethanhua&#39;s blog">
    <meta property="og:image" content="/img/avatar.jpg" />
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="Kotlin"> 

    
        <meta property="article:published_time" content="12月 24, 2018" />
        <meta property="article:modified_time" content="12月 25, 2018" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="了解Kotlin协程实现原理这篇就够了 | Ethanhua&#39;s blog">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/img/avatar.jpg">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://yoursite.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/12/24/kotlin_coroutines/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Ethanhua&#39;s blog",
        "logo": "/img/avatar.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Ethan Hua",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.jpg"
        },
        "description": "keep calm and be happy :)"
    },
    "headline": "了解Kotlin协程实现原理这篇就够了",
    "url": "http://yoursite.com/2018/12/24/kotlin_coroutines/index.html",
    "datePublished": "12月 24, 2018",
    "dateModified": "12月 25, 2018",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://yoursite.com"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    
    
    
    
    
    .footer-sns-github {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+);
    }
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Callback回调"><span class="post-toc-number">1.</span> <span class="post-toc-text">Callback回调</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Future"><span class="post-toc-number">2.</span> <span class="post-toc-text">Future</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Reactive"><span class="post-toc-number">3.</span> <span class="post-toc-text">Reactive</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#kotlin协程"><span class="post-toc-number">4.</span> <span class="post-toc-text">kotlin协程</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Kotlin协程代码实现细节"><span class="post-toc-number"></span> <span class="post-toc-text">Kotlin协程代码实现细节</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#协程的启动"><span class="post-toc-number">1.</span> <span class="post-toc-text">协程的启动</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#协程的挂起"><span class="post-toc-number">2.</span> <span class="post-toc-text">协程的挂起</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#协程的恢复"><span class="post-toc-number">3.</span> <span class="post-toc-text">协程的恢复</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#最后"><span class="post-toc-number"></span> <span class="post-toc-text">最后</span></a>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(/img/kotlin_cover.jpeg)">
    
            <p class="article-headline-p">
                了解Kotlin协程实现原理这篇就够了
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Ethan Hua</strong>
        <span>12月 24, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Kotlin/">Kotlin</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=了解Kotlin协程实现原理这篇就够了&url=http://yoursite.com/2018/12/24/kotlin_coroutines/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=了解Kotlin协程实现原理这篇就够了&url=http://yoursite.com/2018/12/24/kotlin_coroutines/index.html&via=Ethan Hua" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/12/24/kotlin_coroutines/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/12/24/kotlin_coroutines/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <blockquote>
<p>简单来说 <strong>Kotlin协程</strong> 一种异步编程的同步顺序写法，它跟线程是两个不同的概念，所以不要被 <strong>协程</strong> 两字弄混淆</p>
</blockquote>
<p>来看一下一个具体的场景：我们进行网络请求得到数据后处理数据，代码如下</p>
<pre class=" language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">setUpUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">"Ui Data"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"doSomethingElse"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"updateUI<span class="token interpolation variable">$data</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这是一段同步式代码，通常情况 <code>requestData()</code> 是一段耗时操作并不能在主线程执行，不然就会造成主线程阻塞，所以我们把它改写成异步的方式。</p>
<h3 id="Callback回调"><a href="#Callback回调" class="headerlink" title="Callback回调"></a>Callback回调</h3><p>第一种就是我们普遍使用的方式： <strong>异步回调</strong>，把耗时操作之后的逻辑封装成一个回调，耗时操作放在另外一个线程执行</p>
<pre class=" language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">setUpUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        requestDataAsync<span class="token punctuation">{</span>it <span class="token operator">-></span> <span class="token function">processData</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 异步请求数据</span>
    <span class="token keyword">fun</span> <span class="token function">requestDataAsync</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> <span class="token punctuation">(</span>resultData<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread <span class="token punctuation">{</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>函数代码块执行图如下：  </p>
<p><img src="/img/callback_flow.jpg" alt=""></p>
<p>虽然异步回调能很好的处理异步问题，但是有两点坏处：</p>
<ul>
<li>将一条控制流分割成两条控制流，<strong>增加代码复杂性</strong></li>
<li>如果嵌套层级过多，会造成<strong>回调地狱</strong>，同时控制流数量也可能呈指数上升</li>
</ul>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p><code>Java 5</code>后并发包里面引入了<code>Future</code>，一个<code>Future</code>代表一个异步运算未来的值，于是上面的逻辑可以这样写：</p>
<pre class=" language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">setUpUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">val</span> future <span class="token operator">=</span> <span class="token function">requestDataAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">processData</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">requestDataAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Future<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token keyword">val</span> futureTask <span class="token operator">=</span> <span class="token function">FutureTask</span><span class="token punctuation">(</span>Callable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> futureTask
    <span class="token punctuation">}</span>
</code></pre>
<p>函数代码块执行逻辑如下：</p>
<p><img src="/img/future_flow.jpg" alt=""></p>
<p>虽然这样可以解决控制流分叉（把 <code>requestDataAsync</code> 看做一个整体，内部隐藏了异步的细节，从外部来看，执行流就只有主线程的执行流了）和嵌套地狱的问题，但是主线程还是会阻塞。</p>
<blockquote>
<p>在<code>future.get()</code>这一步如果 <strong>线程A</strong> 的任务 <code>requestData</code> 还没有执行完返回结果，则主线程就会调用<code>LockSupport.park()</code>一直阻塞在此处，直到 <code>requestData()</code> 返回结果调用监听此结果的所有线程<code>unpark()</code>恢复执行。</p>
</blockquote>
<p>由此可见 <code>Future</code> 虽然解决了<code>callback</code>的问题，但是引入了新的问题，主线程在调用<code>future.get()</code>的时候会阻塞，显然这样我们是不能接受的。</p>
<h3 id="Reactive"><a href="#Reactive" class="headerlink" title="Reactive"></a>Reactive</h3><p>我们来看另外一种异步编程方式：Java 8 中的 <code>CompleteableFuture</code> 和 <code>RxKotlin</code>，这两者都是同一种风格，我们用<code>RxKotlin</code>举例说明：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">setUpUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Single<span class="token punctuation">.</span>fromCallable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
              <span class="token punctuation">.</span><span class="token function">subscribe</span> <span class="token punctuation">{</span> t <span class="token operator">-></span> <span class="token function">processData</span><span class="token punctuation">(</span>t<span class="token operator">!!</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这种方式的函数代码块执行逻辑流同第一种<code>callback</code>方式。</p>
<p>Rx风格可以有效解决嵌套回调的问题，但是没有解决控制流分叉的问题，<code>RxJava</code>是一个优秀的库，除了解决嵌套回调外，另外拥有丰富的操作符，在处理复杂的事件流方面有着强大的能力，但是有没有更简洁更符合人类思维的写法呢？就如同写同步逻辑样，<strong>koltin协程</strong>为我们提供了可能。</p>
<h3 id="kotlin协程"><a href="#kotlin协程" class="headerlink" title="kotlin协程"></a>kotlin协程</h3><p><strong>kotlin协程</strong> 是一种异步编程的顺序写法，将上诉例子中的代码可以改写成下面这样（为了表达出主线程不会阻塞，加了两行代码）：</p>
<pre class=" language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">setUpUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">val</span> dataDeferred  <span class="token operator">=</span> <span class="token function">requestDataAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> dataDeferred<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token function">doSomethingElse2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">requestDataAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Deferred<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 启动一个异步协程去执行耗时任务</span>
        <span class="token keyword">return</span> GlobalScope<span class="token punctuation">.</span><span class="token function">async</span> <span class="token punctuation">{</span> 
            <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  

    <span class="token keyword">fun</span> <span class="token function">doSomethingElse2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"doSomethingElse2"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这种写法有点类似于 <strong>Future</strong>，<code>Deferred.await()</code>方法如同<code>Future.get()</code>方法，但不同的是 <code>await()</code> 不会阻塞主线程，只是会挂起协程，当<code>requestData()</code>执行完返回结果后，<code>processData()</code>的逻辑会恢复执行，在此时间段，主线程可以去执行其他的逻辑流，并不会阻塞在此处，比如此处会去执行函数 <code>doSomethingElse2()</code>，逻辑执行流如下：</p>
<p><img src="/img/coroutine_flow.jpg" alt=""></p>
<p>由于协程不会阻塞主线程，所以主线程执行顺序有两种可能，如果在调用<code>dataDeferred.await()</code>之后 1s (此处使用<code>Thread.sleep(1000)</code>)后还没有返回结果就执行<code>doSomethingElse2()</code>, 反之先执行 <code>processData()</code>。</p>
<h2 id="Kotlin协程代码实现细节"><a href="#Kotlin协程代码实现细节" class="headerlink" title="Kotlin协程代码实现细节"></a>Kotlin协程代码实现细节</h2><p>由上述的例子我们知道了协程的逻辑执行流，我们来想一想这中间大概是怎么实现的，先思考这段话：</p>
<blockquote>
<p><strong>协程不会阻塞当前线程，执行异步逻辑时将该点之后的代码块的执行中断，在异步回调回来后恢复执行</strong></p>
</blockquote>
<p>这里有两个关键点：  <strong>1 不阻塞</strong> 、<strong>2 中断、恢复执行</strong> </p>
<ul>
<li><p><strong>中断、恢复执行</strong><br>是不是有点类似有线程的运行机制，线程执行代码块时不一定一次就能执行完，cpu 分配的时间片有限，也会经历<strong>暂停-恢复</strong>的过程，终止的时候中间的状态使用线程栈帧来保存，从而使得恢复的时候知道终止时执行到的位置和其他所依赖的中间状态数据。同样，协程在挂起（不同于暂停，挂起不会阻塞线程运行）的时候也需要记录执行位置和一些中间变量。</p>
</li>
<li><p><strong>不阻塞</strong><br>我们要保证不阻塞,同时又要是同步式写法，该怎样做呢？异步回调<code>callback</code>是一种不阻塞的方式，或许协程底层也是这种实现方式（除此之外我不知道有什么不阻塞的底层实现方式），只不过外层帮我们封装成现在的同步式写法了。</p>
</li>
</ul>
<p>带着这两个问题来看协程的源码，看看<code>kotlin</code>协程是怎么解决的，下面进入<strong>高能源码</strong>追踪部分，先来张图提提神</p>
<p><img src="/img/IMG_1205.JPG" alt=""></p>
<p>首先还是从上述例子中的代码为入口分析整个执行流程：</p>
<h3 id="协程的启动"><a href="#协程的启动" class="headerlink" title="协程的启动"></a>协程的启动</h3><p><strong>GlobalScope.launch()</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>
    context<span class="token operator">:</span> CoroutineContext <span class="token operator">=</span> EmptyCoroutineContext<span class="token punctuation">,</span>
    start<span class="token operator">:</span> CoroutineStart <span class="token operator">=</span> CoroutineStart<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">,</span>
    block<span class="token operator">:</span> suspend CoroutineScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit
<span class="token punctuation">)</span><span class="token operator">:</span> Job <span class="token punctuation">{</span>
    <span class="token keyword">val</span> newContext <span class="token operator">=</span> <span class="token function">newCoroutineContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token keyword">val</span> coroutine <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">.</span>isLazy<span class="token punctuation">)</span>
        <span class="token function">LazyStandaloneCoroutine</span><span class="token punctuation">(</span>newContext<span class="token punctuation">,</span> block<span class="token punctuation">)</span> <span class="token keyword">else</span>
        <span class="token function">StandaloneCoroutine</span><span class="token punctuation">(</span>newContext<span class="token punctuation">,</span> active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    coroutine<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> coroutine<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
    <span class="token keyword">return</span> coroutine
<span class="token punctuation">}</span>
</code></pre>
<p>第一个参数 <strong>context</strong> 是协程上下文，此处我们传入了 <strong>Main</strong> 用于主线程调度，先忽略这部分。<br>第二个参数 <strong>start</strong> 此处我们没有传值则使用默认值，代表启动方式默认值为立即执行。<br>第三个参数 <strong>block</strong> 是协程真正执行的代码块，即我们例子中的<code>launch{}</code>花括号中的代码块，此处为一个<code>suspend CoroutineScope.() -&gt; Unit</code>函数，这是怎么来的呢？我们编写代码的时候并没有这个东西，其实它由编译器生成的，我们的<code>block</code>代码块经过编译器编译后会生成一个继承<code>Continuation</code>的类，为了关注主要逻辑方便理解，去掉了一些无关代码大概代码如下:</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">final</span> void <span class="token function">setUpUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BuildersKt__Builders_commonKt<span class="token punctuation">.</span>launch$<span class="token function">default</span><span class="token punctuation">(</span>GlobalScope<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">,</span> 
        Dispatchers<span class="token punctuation">.</span><span class="token function">getMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 传入的是一个 KotlinTest$setUpUI.KotlinTest$setUpUI$1 对象</span>
        <span class="token punctuation">(</span>Function2<span class="token punctuation">)</span>new KotlinTest$setUpUI<span class="token punctuation">.</span>KotlinTest$setUpUI$<span class="token function">1</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Continuation<span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomethingElse2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> setUpUI$<span class="token number">1</span> extends SuspendLambda implements Function2<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> Object <span class="token function">invokeSuspend</span><span class="token punctuation">(</span>Object result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            case <span class="token number">0</span><span class="token operator">:</span>
                <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 新建并启动 async 协程</span>
                Deferred async$default <span class="token operator">=</span> BuildersKt<span class="token punctuation">.</span>async$<span class="token function">default</span><span class="token punctuation">(</span>coroutineScope<span class="token punctuation">,</span> <span class="token punctuation">(</span>CoroutineContext<span class="token punctuation">)</span> Dispatchers<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Function2<span class="token punctuation">)</span> new <span class="token function">1</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果 async 协程还没完成为挂起状态 则直接返回，等待下次唤醒重入</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>async$default<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">==</span> coroutine_suspended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> coroutine_suspended<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            case <span class="token number">1</span><span class="token operator">:</span>
                <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
                <span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到传入到 <code>launch</code> 函数第三个参数位置的是一个编译后生成的 <code>SuspendLambda</code> 类实例<br><code>SuspendLambda</code> 本质上是一个 <code>Continuation</code>，而 Continuation 是一个有着恢复操作的接口，刚好对应了我们上面例子中提到的<strong>终止-恢复</strong>的<strong>恢复执行逻辑</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">/**
 * 在一个挂起点之后可以返回类型T值的续集continuation的接口
 * Interface representing a continuation after a suspension point that returns value of type `T`.
 */</span>
<span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span><span class="token string">"1.3"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> Continuation<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * Context of the coroutine that corresponds to this continuation.
     */</span>
    <span class="token comment" spellcheck="true">// todo: shall we provide default impl with EmptyCoroutineContext?</span>
    <span class="token keyword">public</span> <span class="token keyword">val</span> context<span class="token operator">:</span> CoroutineContext

    <span class="token comment" spellcheck="true">/**
     * Resumes the execution of the corresponding coroutine passing successful or failed [result] as the
     * return value of the last suspension point.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">resumeWith</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Result<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>SuspendLambda</code> 继承结构如下</p>
<blockquote>
<p><code>SuspendLambda</code> &gt; <code>ContinuationImpl</code> &gt; <code>BaseContinuationImpl</code> &gt; <code>Continuation</code></p>
</blockquote>
<p>每一层封装对应添加了不同的功能，我们先忽略掉这些功能细节，着眼于我们的主线，继续跟进<code>launch</code> 函数执行过程，由于第二个参数是默认值，所以创建的是  <code>StandaloneCoroutine</code>， 调用链如下： </p>
<p><code>coroutine.start(start, coroutine, block)</code><br>-&gt; <code>CoroutineStart.start(block, receiver, this)</code><br>-&gt; <code>CoroutineStart.invoke(block: suspend () -&gt; T, completion: Continuation&lt;T&gt;)</code><br>-&gt; <code>block.startCoroutineCancellable(completion)</code><br>-&gt; <code>createCoroutineUnintercepted(completion).intercepted().resumeCancellable(Unit)</code></p>
<p>最后走到<br><code>createCoroutineUnintercepted(completion).intercepted().resumeCancellable(Unit)</code></p>
<p>这里创建了一个协程，并链式调用 <code>intercepted</code>、<code>resumeCancellable</code> 方法，利用协程上下文中的 <code>ContinuationInterceptor</code> 对协程的执行进行拦截，<code>intercepted</code> 实际上调用的是 <code>ContinuationImpl</code> 的 <code>intercepted</code> 方法</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token function">ContinuationImpl</span><span class="token punctuation">(</span>
    completion<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> _context<span class="token operator">:</span> CoroutineContext<span class="token operator">?</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">BaseContinuationImpl</span><span class="token punctuation">(</span>completion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">intercepted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span>
        intercepted
            <span class="token operator">?:</span> <span class="token punctuation">(</span>context<span class="token punctuation">[</span>ContinuationInterceptor<span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">interceptContinuation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> intercepted <span class="token operator">=</span> it <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>context[ContinuationInterceptor]?.interceptContinuation</code>调用的是 <code>CoroutineDispatcher</code> 的 <code>interceptContinuation</code> 方法</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">interceptContinuation</span><span class="token punctuation">(</span><span class="token annotation builtin">@NotNull</span> <span class="token keyword">final</span> Continuation<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> continuation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Intrinsics<span class="token punctuation">.</span><span class="token function">checkParameterIsNotNull</span><span class="token punctuation">(</span>continuation<span class="token punctuation">,</span> <span class="token string">"continuation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> new DispatchedContinuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> continuation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>最终创建了一个 <code>DispatchedContinuation</code> 可分发的协程实例，我们继续看<code>resumeCancellable</code> 方法</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">resumeCancellable</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 判断是否是DispatchedContinuation 根据我们前面的代码追踪 这里是DispatchedContinuation</span>
    <span class="token keyword">is</span> DispatchedContinuation <span class="token operator">-></span> <span class="token function">resumeCancellable</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token function">resume</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token function">resumeCancellable</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 判断是否需要线程调度 </span>
        <span class="token comment" spellcheck="true">// 由于我们之前使用的是 `GlobalScope.launch(Main)` Android主线程调度器所以这里为true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatcher<span class="token punctuation">.</span><span class="token function">isDispatchNeeded</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _state <span class="token operator">=</span> value
            resumeMode <span class="token operator">=</span> MODE_CANCELLABLE
            dispatcher<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            UndispatchedEventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> MODE_CANCELLABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">resumeCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resumeUndispatched</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>最终走到 <code>dispatcher.dispatch(context, this)</code> 而这里的 <code>dispatcher</code> 就是通过工厂方法创建的 <code>HandlerDispatcher</code>  ，<code>dispatch()</code> 函数第二个参数<code>this</code>是一个<code>runnable</code>这里为 <code>DispatchedTask</code></p>
<p><strong>HandlerDispatcher</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">/**
 * Implements [CoroutineDispatcher] on top of an arbitrary Android [Handler].
 */</span>
<span class="token keyword">internal</span> <span class="token keyword">class</span> HandlerContext <span class="token keyword">private</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> invokeImmediately<span class="token operator">:</span> Boolean
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">HandlerDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Delay <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">//  最终执行这里的 dispatch方法 而handler则是android中的 MainHandler</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">,</span> block<span class="token operator">:</span> Runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里借用 Android 的主线程消息队列来在主线程中执行 <code>block Runnable</code> 而这个 <code>Runnable</code> 即为 <code>DispatchedTask</code></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> DispatchedTask<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@JvmField</span> <span class="token keyword">var</span> resumeMode<span class="token operator">:</span> Int
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">SchedulerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token function">withCoroutineContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> delegate<span class="token punctuation">.</span>countOrElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>job <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>job<span class="token punctuation">.</span>isActive<span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// 异常情况下</span>
                    continuation<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getCancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">val</span> exception <span class="token operator">=</span> <span class="token function">getExceptionalResult</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// 异常情况下</span>
                        continuation<span class="token punctuation">.</span><span class="token function">resumeWithStackTrace</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
                    <span class="token keyword">else</span>
                        <span class="token comment" spellcheck="true">// 正常情况下走到这一步</span>
                        continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token function">getSuccessfulResult</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
             <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@InlineOnly</span> <span class="token keyword">public</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span>
    <span class="token function">resumeWith</span><span class="token punctuation">(</span>Result<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">internal</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token function">BaseContinuationImpl</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 实现 Continuation 的 resumeWith，并且是 final 的，不可被重写</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">resumeWith</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Result<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token keyword">val</span> outcome <span class="token operator">=</span> <span class="token function">invokeSuspend</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 由编译生成的协程相关类来实现，例如 setUpUI$1</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">invokeSuspend</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Result<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最终调用到 <code>continuation.resumeWith()</code> 而 <code>resumeWith()</code> 中会调用 <code>invokeSuspend</code>，即之前编译器生成的 <code>SuspendLambda</code> 中的 <code>invokeSuspend</code> 方法</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">final</span> <span class="token keyword">class</span> setUpUI$<span class="token number">1</span> extends SuspendLambda implements Function2<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> Object <span class="token function">invokeSuspend</span><span class="token punctuation">(</span>Object result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            case <span class="token number">0</span><span class="token operator">:</span>
                <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 新建并启动 async 协程</span>
                Deferred async$default <span class="token operator">=</span> BuildersKt<span class="token punctuation">.</span>async$<span class="token function">default</span><span class="token punctuation">(</span>coroutineScope<span class="token punctuation">,</span> <span class="token punctuation">(</span>CoroutineContext<span class="token punctuation">)</span> Dispatchers<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Function2<span class="token punctuation">)</span> new <span class="token function">1</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果 async 协程还没完成为挂起状态 则直接返回，等待下次唤醒重入</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>async$default<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">==</span> coroutine_suspended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> coroutine_suspended<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            case <span class="token number">1</span><span class="token operator">:</span>
                <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
                <span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p><strong>这段代码是一个状态机机制，每一个挂起点都是一种状态，协程恢复只是跳转到下一个状态，挂起点将执行过程分割成多个片段，利用状态机的机制保证各个片段按顺序执行。</strong></p>
</blockquote>
<p>如果没有挂起点就只有一个初始状态，类似于<code>callback</code>回调，所以对应了之前我们分析的非阻塞的异步底层实现其实也是一种<code>callback</code>回调，只不过有多个挂起点时就会有多个<code>callback</code>回调，我们把多个<code>callback</code>回调封装成了一个<strong>状态机</strong>。</p>
<p>到这里就完成了协程的启动过程，下面我们来分析协程的终止过程 （挂起过程）</p>
<h3 id="协程的挂起"><a href="#协程的挂起" class="headerlink" title="协程的挂起"></a>协程的挂起</h3><p>从上文可知协程的启动经历 <strong>构建协程</strong> -&gt; <strong>线程调度</strong> -&gt; <strong>协程 resume</strong> 三个过程进入到编译器生成的 <code>SuspendLambda</code> 的 <code>invokeSuspend</code> 方法中的</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">if</span> <span class="token punctuation">(</span>async$default<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">==</span> coroutine_suspended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> coroutine_suspended<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>async</code> 也是一个协程，如果状态为挂起<code>coroutine_suspended</code>，则执行流直接 return 返回，如果已达到完成状态直接跳转下一个状态 case 1 最终走完整个协程代码块。</p>
<p>这里需要注意的是：</p>
<ul>
<li>启动一个新的协程并不会挂起当前协程，只有当使用库函数 <code>await</code>、<code>yield</code>方法时才会将当前的协程挂起。</li>
<li>协程挂起并不会阻塞线程，线程在挂起点 return 后可以去执行其他的代码块。</li>
</ul>
<p>协程的挂起过程很简单，代码块直接返回，当前状态保存在状态机 <code>SuspendLambda</code> 中，可以想象到协程恢复的时候也是调用 <code>SuspendLambda</code> 的 <code>invokeSuspend</code> 从而进入下一个状态继续执行的。</p>
<h3 id="协程的恢复"><a href="#协程的恢复" class="headerlink" title="协程的恢复"></a>协程的恢复</h3><p>通过前面的代码，我们大概可以想到，协程A 的恢复是在 新协程B 执行完毕后调用 协程A 的 <code>resume</code> 函数从而进入状态机恢复执行的, 这样 新协程B 就得持有 协程A 的引用，然后在执行完成后通知 协程A 恢复执行<br>事实也是如此，我们从<code>await</code>方法入手</p>
<p><strong>DeferredCoroutine</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">open</span> <span class="token keyword">class</span> DeferredCoroutine<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>
    parentContext<span class="token operator">:</span> CoroutineContext<span class="token punctuation">,</span>
    active<span class="token operator">:</span> Boolean
<span class="token punctuation">)</span> <span class="token operator">:</span> AbstractCoroutine<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>parentContext<span class="token punctuation">,</span> active<span class="token punctuation">)</span><span class="token punctuation">,</span> Deferred<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> SelectClause1<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">override</span> suspend <span class="token keyword">fun</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token operator">=</span> <span class="token function">awaitInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> T
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> suspend <span class="token keyword">fun</span> <span class="token function">awaitInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// fast-path -- check state (avoid extra object creation)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// lock-free loop on state</span>
            <span class="token keyword">val</span> state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!</span><span class="token keyword">is</span> Incomplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// already complete -- just return result</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token keyword">is</span> CompletedExceptionally<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Slow path to recover stacktrace</span>
                    <span class="token function">recoverAndThrow</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>cause<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 已完成的话直接拆箱返回结果值</span>
                <span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">unboxState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startInternal</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token comment" spellcheck="true">// break unless needs to retry</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 未完成走这里</span>
        <span class="token keyword">return</span> <span class="token function">awaitSuspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// slow-path</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span> suspend <span class="token keyword">fun</span> <span class="token function">awaitSuspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token operator">=</span> suspendCoroutineUninterceptedOrReturn <span class="token punctuation">{</span> uCont <span class="token operator">-></span>
        <span class="token comment" spellcheck="true">/*
         * Custom code here, so that parent coroutine that is using await
         * on its child deferred (async) coroutine would throw the exception that this child had
         * thrown and not a JobCancellationException.
         */</span>
        <span class="token keyword">val</span> cont <span class="token operator">=</span> <span class="token function">AwaitContinuation</span><span class="token punctuation">(</span>uCont<span class="token punctuation">.</span><span class="token function">intercepted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        cont<span class="token punctuation">.</span><span class="token function">disposeOnCancellation</span><span class="token punctuation">(</span><span class="token function">invokeOnCompletion</span><span class="token punctuation">(</span><span class="token function">ResumeAwaitOnCompletion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cont<span class="token punctuation">)</span><span class="token punctuation">.</span>asHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cont<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>awaitSuspend()</code> 函数中有三个过程我们需要关注</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">// 1 这里拿到了调用await代码的协程</span>
suspendCoroutineUninterceptedOrReturn<span class="token punctuation">{</span> uCont <span class="token operator">-></span>
       <span class="token comment" spellcheck="true">// doSomething</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// asHandler 有点事件回调的引子</span>
<span class="token function">ResumeAwaitOnCompletion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cont<span class="token punctuation">)</span><span class="token punctuation">.</span>asHandler
<span class="token comment" spellcheck="true">// 当完成时执行</span>
<span class="token function">invokeOnCompletion</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> CompletionHandler<span class="token punctuation">)</span>
</code></pre>
<p><code>suspendCoroutineUninterceptedOrReturn() lambda</code>直接返回了一个协程实例 <code>uCont</code>，我们大概可以确定这就是调用者协程的引用，源码里并没有看到实现，但是通过查看<code>JobSupport</code>的 class 源码发现调用<code>await</code>的时候就已经将当前协程作为参数传入了进去:</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">// 这里已经将this传入了进去</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>async$default<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">==</span> coroutine_suspended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> coroutine_suspended<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>再来看 <code>ResumeAwaitOnCompletion(this, cont).asHandler</code></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">class</span> ResumeAwaitOnCompletion<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>
    job<span class="token operator">:</span> JobSupport<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> continuation<span class="token operator">:</span> CancellableContinuationImpl<span class="token operator">&lt;</span>T<span class="token operator">></span>
<span class="token punctuation">)</span> <span class="token operator">:</span> JobNode<span class="token operator">&lt;</span>JobSupport<span class="token operator">></span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>cause<span class="token operator">:</span> Throwable<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// handler 内部调用 continuation.resume 函数恢复协程执行</span>
        continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">unboxState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> T<span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>构建了一个 <code>ResumeAwaitOnCompletion</code> 对象作为 <code>JobNode</code>任务节点，同时作为一个 <code>Handler</code> 回调对象。<br><strong>invokeOnCompletion</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">// 当前代码分支有点多，简化代码如下：</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invokeOnCompletion</span><span class="token punctuation">(</span>
        onCancelling<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
        invokeImmediately<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
        handler<span class="token operator">:</span> CompletionHandler
    <span class="token punctuation">)</span><span class="token operator">:</span> DisposableHandle <span class="token punctuation">{</span>
        loopOnState <span class="token punctuation">{</span> state <span class="token operator">-></span>
            <span class="token keyword">when</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">..</span><span class="token punctuation">.</span> 
                <span class="token keyword">is</span> Incomplete <span class="token operator">-></span> <span class="token punctuation">{</span>
                    <span class="token keyword">val</span> node <span class="token operator">=</span> nodeCache <span class="token operator">?:</span> <span class="token function">makeNode</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> onCancelling<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> nodeCache <span class="token operator">=</span> it <span class="token punctuation">}</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addLastAtomic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> list<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token label symbol">@loopOnState</span>
                    <span class="token keyword">return</span> node
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// is complete</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeImmediately<span class="token punctuation">)</span> handler<span class="token punctuation">.</span><span class="token function">invokeIt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token keyword">as</span><span class="token operator">?</span> CompletedExceptionally<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>cause<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> NonDisposableHandle
                <span class="token punctuation">}</span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>如果新协程还未执行完成则将<code>handler</code>构造成一个<code>Node</code>并添加节点列表中去，函数返回 node，如果已经完成了则直接调用 <code>handler.invokeIt</code> 从而调用到 <code>Continuation.resume</code> 恢复执行。</p>
<p>到这里已经很明显了，将调用<code>await</code>的协程构造成一个 <code>handler node</code> 节点添加到新协程的 node 列表中，待新协程执行完毕后，循环列表通知每个<code>handler</code>恢复其协程的执行，这里用列表来保存<code>handler</code> 是因为可能有许多个协程调用<code>await</code>等待这个指定协程的完成，后面就不继续贴代码了，恢复流程如下：</p>
<p>从 <code>async</code> 协程的 <code>SuspendLambda</code> 的子类的<br><code>completion.resumeWith(outcome)</code><br>-&gt; <code>AbstractCoroutine.resumeWith(result)</code><br>-&gt; <code>JobSupport.tryFinalizeSimpleState()</code><br>-&gt; <code>JobSupport.completeStateFinalization()</code><br>-&gt; <code>state.list?.notifyCompletion(cause)</code><br>-&gt; <code>node.invoke</code></p>
<p>到这里协程的整个调用执行流过程就分析完了，我们跟踪源码前的两个问题也得到了答案。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>协程只是编程历史发展过程中产生的对开发者友好的一种异步编程方式，相对于传统的多线程并发编程并不能提高额外的性能，协程并发编程的底层仍是用线程池实现，因为耗时的操作总要线程去执行，协程并不能减少额外的执行逻辑，另外协程因为创建了中间的一系列封装对象，比传统的多线程编程增加了额外的内存消耗，官方文档对此特定说明了编译器会进行一些优化，从而尽可能减少内存消耗，开发者无需担心，但协程所带来的开发维护成本大大减低、内存上的妥协带来的是对开发者的友好还是值得的。  </p>
<p><strong>总结一下协程的优势</strong>  </p>
<ul>
<li><strong>简洁</strong> 更高抽象隐藏异步实现细节，实现写异步如同同步的顺序式写法</li>
<li><strong>比闭包更好用的上下文参数</strong>  传统回调方式严重依赖闭包特性，而要在一个连续逻辑中写出多个回调函数且共享相同的上下文，这样的代码难读懂、难写对、难维护，协程就简单多了，一个上下文抽象搞定</li>
<li><strong>更方便处理并发逻辑</strong> 父子协程概念 可以更容易的管理协程的执行</li>
</ul>
<blockquote>
<p>这边文章只分析的协程的主干实现逻辑，另外的功能还没有分析，比如 上下文的抽象、错误处理、通道模型等等，另外思考下这几个问题：<strong>Java</strong> 中为什么没有协程? 其他语言协程的实现方式同 <strong>Kotlin</strong> 一样吗？比如 <strong>C#/Python</strong></p>
</blockquote>
<p>下篇文章来揭晓，谢谢阅读！祝大家圣诞节快乐！<br><strong>Thanks</strong> <a href="https://github.com/Kotlin/KEEP/blob/master/proposals/coroutines.md" target="_blank" rel="noopener">Kotlin协程官方设计文档</a></p>
<p><img src="/img/IMG_1206.JPG" alt=""></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/12/09/growth/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="Ethan Hua's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        65351871@qq.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/12/">十二月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/04/">四月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/03/">三月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">二月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android/">Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Arithmetic/">Arithmetic<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Jvm/">Jvm<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/RxJava-Android/">RxJava/Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/UI-Android/">UI/Android<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/架构组件-Android/">架构组件/Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/语言基础/">语言基础<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/进程通信-Linux/">进程通信/Linux<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/随笔/">随笔<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/音视频-Android/">音视频/Android<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">18</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ethanhua" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Ethanhua's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
