<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            理解Android中的进程通信 | 
        
        Ethanhua&#39;s blog
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Ethan Hua">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="blog,Android">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/avatar.jpg">
    <link rel="icon" sizes="192x192" href="/img/avatar.jpg">
    <link rel="apple-touch-icon" href="/img/avatar.jpg">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Ethanhua&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="理解Android中的进程通信 | Ethanhua&#39;s blog">
    <meta property="og:image" content="/img/avatar.jpg" />
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="Android"> 

    
        <meta property="article:published_time" content="4月 28, 2018" />
        <meta property="article:modified_time" content="5月 03, 2018" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="理解Android中的进程通信 | Ethanhua&#39;s blog">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/img/avatar.jpg">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://yoursite.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/04/28/android_ipc/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Ethanhua&#39;s blog",
        "logo": "/img/avatar.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Ethan Hua",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.jpg"
        },
        "description": "keep calm and be happy :)"
    },
    "headline": "理解Android中的进程通信",
    "url": "http://yoursite.com/2018/04/28/android_ipc/index.html",
    "datePublished": "4月 28, 2018",
    "dateModified": "5月 03, 2018",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://yoursite.com"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    
    
    
    
    
    .footer-sns-github {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+);
    }
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#背景知识"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景知识</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#进程隔离"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">进程隔离</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#进程通信"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">进程通信</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#为什么是-Binder"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">为什么是 Binder ?</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Binder"><span class="post-toc-number">2.</span> <span class="post-toc-text">Binder</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Android中几种特定的-Binder"><span class="post-toc-number">3.</span> <span class="post-toc-text">Android中几种特定的 Binder</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ActivityManagerService"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">ActivityManagerService</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#AIDL"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">AIDL</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ContentProvider"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">ContentProvider</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#BroadcastReceiver"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">BroadcastReceiver</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Messenger"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">Messenger</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Activity-启动流程"><span class="post-toc-number">4.</span> <span class="post-toc-text">Activity 启动流程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#用户-App-进程"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">用户 App 进程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ActivityManagerService-服务进程"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">ActivityManagerService 服务进程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#用户-App-进程-1"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">用户 App 进程</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#最后"><span class="post-toc-number">5.</span> <span class="post-toc-text">最后</span></a></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(/img/headerImg429.jpeg)">
    
            <p class="article-headline-p">
                理解Android中的进程通信
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Ethan Hua</strong>
        <span>4月 28, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Android/">Android</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=理解Android中的进程通信&url=http://yoursite.com/2018/04/28/android_ipc/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=理解Android中的进程通信&url=http://yoursite.com/2018/04/28/android_ipc/index.html&via=Ethan Hua" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/04/28/android_ipc/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/04/28/android_ipc/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <blockquote>
<p>众所周知 Android 中采用 Binder 机制来进行进程通信，且应用层基于 Binder 封装了几种特定类型的通信方式来简化不同场景下的进程通信，正确理解 Binder 对于理解整个 Android 系统有着至关重要的作用，Binder 底层原理十分复杂且难以理解，如果直接去看源码容易身陷其中不知所云，网上已经有一批学习 Binder 的深度好文，我们可以先在熟练使用 AIDL 或者手写 Binder 进行进程通信的前提下来阅读这些文章并亲自跟踪源码来逐步“掌控”它，本文的内容对于具体实现原理方面不会过多涉及，主要从上层需求及设计层面来自顶向下分析，大概分三个部分，第一部分为 Binder 的介绍，第二部分为 Android 中的几种特定 Binder，第三部分从 Activity 的启动流程来分析 Binder 在其中的作用。</p>
</blockquote>
<h1 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h1><h2 id="进程隔离"><a href="#进程隔离" class="headerlink" title="进程隔离"></a>进程隔离</h2><p>进程隔离的存在使得进程之间互相交流时需要进行进程通信，简单来说进程隔离是为了保证进程间互不影响，试想如果不隔离，用户创建的一个进程挂掉了可能会导致其它的进程也会随之挂掉，显然这样不合理，进程隔离的维基百科解释如下：</p>
<blockquote>
<p>进程隔离是为保护操作系统中进程互不干扰而设计的一组不同硬件和软件的技术。这个技术是为了避免进程A写入进程B的情况发生。 进程的隔离实现，使用了虚拟地址空间。进程A的虚拟地址和进程B的虚拟地址不同，这样就防止进程A将数据信息写入进程B。</p>
</blockquote>
<h2 id="进程通信"><a href="#进程通信" class="headerlink" title="进程通信"></a>进程通信</h2><p>不同进程间使用的内存空间不同，相互之间不能直接进行访问通信，如果进程间需要进行通信，必定需要借助一个公共的第三方内存空间来完成，这个第三方空间有两种形式，第一种就是<strong>共享内存</strong>，即不同进程间共享有着一份相同的内存区间，第二种就是使用<strong>内核空间</strong>来中转，内核充当中间人的角色 ，用来连接不同进程间的数据交互，内核是系统的核心，安全级别很高，不是随随便便能访问的，不然弄坏了咋办，内核空间向外界暴露一些接口供其调用(<strong>系统调用</strong>)，通过统一的接口，所有的资源访问都是在内核的控制下执行，以免导致用户程序对系统资源的越权访问，从而保证了系统的安全和稳定。</p>
<blockquote>
<p>当一个任务（进程）执行系统调用而陷入内核代码中执行时，我们就称进程处于内核运行态（或简称为内核态）此时处理器处于特权级最高的（0级）内核代码中执行。当进程在执行用户自己的代码时，则称其处于用户运行态（用户态）。即此时处理器在特权级最低的（3级）用户代码中运行。处理器在特权等级高的时候才能执行那些特权CPU指令</p>
</blockquote>
<h2 id="为什么是-Binder"><a href="#为什么是-Binder" class="headerlink" title="为什么是 Binder ?"></a>为什么是 Binder ?</h2><p>Android系统是基于 Linux 系统的，在 Linux 系统上进程通信已经有了一些解决方案 如管道，消息队列, 共享内存, Socket等， 管道，消息队列，Socket都是内核作为中转的通信实现方式，共享内存则是以消除内存隔离直接访问的形式来进行通信。<br>那么既有方案这么多，为什么要重新造出一个 binder 来进行进程通信呢？主要是基于两点考虑，<strong>效率</strong>和<strong>安全性</strong></p>
<ul>
<li><strong>效率</strong><br>管道，消息队列，Socket 用内核作为中转的方式会经历2次内存拷贝，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方缓存区。共享内存虽然无需拷贝，但控制复杂，难以使用。而 Binder 采用内存映射的方式只需要一次拷贝，所以在效率上大大提升。<br><center><br><img src="/img/ipc1.jpg" alt=""><br><strong>传统通信</strong><br><img src="/img/ipc2.jpg" alt=""><br><strong>Binder通信</strong><br></center></li>
</ul>
<ul>
<li><strong>安全性</strong><br>Android 作为一个开放式的平台，应用程序的来源广泛，确保智能终端的安全是非常重要的。终端用户不希望从网上下载的程序在不知情的情况下偷窥隐私数据，连接无线网络，长期操作底层设备导致电池很快耗尽等等。传统 IPC 没有任何安全措施，完全依赖上层协议来确保，容易被伪造。而Binder机制从协议上支持通信双方的身份验证，不易被篡改，所以在安全性上大大提升。</li>
</ul>
<h1 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h1><p>Binder 采用C/S架构的通信方式，类似于传统的 web 通信，请求发起方为 Client 端，请求接收处理方为 Server 端，具有同传统 C/S 架构相同的模块，如通信入口、通信协议、Server 端接收线程管理等等，同时又具有面向对象的特性，这里引用一段<a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">Android Bander设计与实现 - 设计篇</a>的描述再合适不过：</p>
<blockquote>
<p>面向对象思想的引入将进程间通信转化为通过对某个 Binder 对象的引用调用该对象的方法，而其独特之处在于 Binder 对象是一个可以跨进程引用的对象，它的实体位于一个进程中，而它的引用却遍布于系统的各个进程之中。最诱人的是，这个引用和java里引用一样既可以是强类型，也可以是弱类型，而且可以从一个进程传给其它进程，让大家都能访问同一 Server ，就象将一个对象或引用赋值给另一个引用一样。Binder 模糊了进程边界，淡化了进程间通信过程，整个系统仿佛运行于同一个面向对象的程序之中。形形色色的Binder对象以及星罗棋布的引用仿佛粘接各个应用程序的胶水，这也是Binder在英文里的原意</p>
</blockquote>
<p>这种 C/S 通信方式在 Binder 的实现中有四种角色：Server，Client，ServiceManager 以及 Binder 驱动，类似于 Web 通信中的 Web 服务器，App或者浏览器，DNS域名服务器，路由器。</p>
<p><img src="/img/binder-model.png" alt=""></p>
<p>大概流程如上图所示：服务端先将提供的服务注册到 ServiceManager, 客户端调用时根据事先注册的标识符字符串来从中间者 ServiceManager 中查找相关服务，并通过 Binder 驱动完成对相应服务的通信过程，这里的标识符字符串类似于 Web 通信中的 url。<br>不同于 web 通信通过 url 只拥有执行具体单个方法的能力的是 Binder 机制中通过标识符字符串客户端会持有目标服务接口对象，拥有访问其所有公有方法和字段的能力，不过该对象并不是真实对象而是一个代理对象，它会将输入数据和具体方法的 KeyCode 包装起来交给 Binder 驱动，Binder 驱动完成底层数据传输到服务器中的具体实现 Binder 真实对象，解析数据并完成真实的操作并将数据返回。</p>
<p><img src="/img/binder-procedure.png" alt=""></p>
<p>说了这么多理论，我们再来看一下一个简单的 Binder 使用的代码实现加深下理解。</p>
<p><strong>1 定义一个有数字相加能力的接口，此处需要继承IInterface接口</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICalculateManager</span> <span class="token keyword">extends</span> <span class="token class-name">IInterface</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>2 添加服务端的这个接口的具体实现，需要继承 Binder 使其拥有跨进程通信的能力</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Stub</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">ICalculateManager</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DESCRIPTOR <span class="token operator">=</span> <span class="token string">"com.ethanhua.artstudydemo.ipc.ICalculateManager"</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">attachInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> ICalculateManager <span class="token function">asInterface</span><span class="token punctuation">(</span>IBinder obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            IInterface localI <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localI <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> localI <span class="token keyword">instanceof</span> <span class="token class-name">ICalculateManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>ICalculateManager<span class="token punctuation">)</span> localI<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> IBinder <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Parcel data<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Parcel reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> TRANSACTION_add<span class="token operator">:</span> <span class="token punctuation">{</span>
                    data<span class="token punctuation">.</span><span class="token function">enforceInterface</span><span class="token punctuation">(</span>DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> intArr <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">createIntArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>intArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> intArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    reply<span class="token punctuation">.</span><span class="token function">writeNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    reply<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTransact</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><code>asInterface</code> 方法中会判断是否是本地 Binder 对象还是远程 Binder 对象，如果是本地 Binder 对象直接转换成对应的功能接口对象返回，如果是远程代理对象，则构建一个代理类返回，外界通过这个代理类来完成功能调用。</p>
<p><code>onTransact</code> 方法完成实际的数据解析及方法调用，可以看出 Binder 通信中采用 Parcel 这种数据结构存储输入函数的参数值和函数执行的返回值，也就是为什么四大组件中采用 Parcelable 作为通信数据结构。code 用来标识具体请求调用哪一个方法。</p>
<p><strong>3 添加代理类实现</strong>  </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span>  <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">ICalculateManager</span> <span class="token punctuation">{</span>
            <span class="token keyword">private</span> IBinder mRemote<span class="token punctuation">;</span>

            <span class="token keyword">public</span> <span class="token function">Proxy</span><span class="token punctuation">(</span>IBinder remote<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
                Parcel data <span class="token operator">=</span> Parcel<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Parcel reply <span class="token operator">=</span> Parcel<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> result<span class="token punctuation">;</span>
                data<span class="token punctuation">.</span><span class="token function">writeIntArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>TRANSACTION_add<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> IBinder <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mRemote<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>add</code> 方法内中会将参数打包调用远程代理对象的 <code>transact</code>方法去执行对应的方法，<code>transact</code> 最终会调用到上面 stub 类中的 <code>onTransact</code> 方法</p>
<p><strong>4 注册到 ServiceManager</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin">ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>ICalculateManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span>DESCRIPTOR<span class="token punctuation">,</span> ICalculateManager<span class="token punctuation">.</span><span class="token function">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>5 发起调用</strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> iBinder <span class="token operator">=</span> ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>ICalculateManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span>DESCRIPTOR<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//获取注册的IBinder</span>
<span class="token keyword">val</span> calManager <span class="token operator">=</span> ICalculateManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>iBinder<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//转换为数字相加功能接口对象</span>
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token string">"ipc sum:<span class="token interpolation"><span class="token delimiter variable">${</span>calManager<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 调用其add方法得到计算结果</span>
</code></pre>
<p>整个流程是： 首先通过 ServiceManager 注册 ICalculateManager.Stub 的远程代理对象，因为 ServiceManager 也是运行在一个独立进程中，所以这个过程也是一个跨进程通信，那怎样才能拿到 ServiceManager 呢？Binder 中通过提前预置 ServiceManager 来解决这个问题，每个客户端通过写死的0号引用来获取 ServiceManager，类似于域名服务器地址，你得提前预置好。然后客户端通过 ServiceManager 来获取已经注册好的远程代理对象，调用这个对象的本地代理对象对应的方法传输该方法的参数、标识符到远程进程，远程进程通过创建好的线程来接收此次调用，并执行对应的 onTransact 方法解析数据完成实际的方法调用，并将结果返回。</p>
<h1 id="Android中几种特定的-Binder"><a href="#Android中几种特定的-Binder" class="headerlink" title="Android中几种特定的 Binder"></a>Android中几种特定的 Binder</h1><p>虽然 Binder 为进程通信提供了支持，但是一些通用的场景还是需要进行一些封装来简化调用，下面我们来看一下 Android 上基于 Binder 的一些上层封装。</p>
<h2 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h2><p><code>ActivityManagerService</code> 虽名为 Activity 管理服务但它不仅仅管理 Activity， Android 中四大组件之间的通信都是依赖于它来进行，<code>ActivityManagerService</code> 继承自 <code>ActivityManagerNative</code>，而 <code>ActivityManagerNative</code> 是一个实现了 <code>IActivityManager</code> 功能的 Binder，<code>ActivityManagerService</code> 这里类似于上面的 <code>ICalculateManager.Stub()</code> 是服务端的 Binder 功能实现类。它的客户端代理类是 <code>ActivityManagerProxy</code>，它的注册是在系统启动过程中被注册的，具体是在 <code>SystemServer</code> 中的 <code>startBootstrapServices()</code> 方法中调用 <code>ActivityManagerService.setSystemProcess()</code> 方法中向 <code>ServiceManager</code> 中注册的，它的代理对象保存在 <code>ActivityManagerNative</code> 的单例 <code>gDefault</code> 字段中。</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityManagerService<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>ACTIVITY_SERVICE<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//注册 ActivityManagerService</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>ProcessStats<span class="token punctuation">.</span>SERVICE_NAME<span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"meminfo"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MemBinder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"gfxinfo"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GraphicsBinder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"dbinfo"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DbBinder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"cpuinfo"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CpuBinder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"permission"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PermissionController</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"processinfo"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ProcessInfoService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ApplicationInfo info <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>
                    <span class="token string">"android"</span><span class="token punctuation">,</span> STOCK_PM_FLAGS <span class="token operator">|</span> MATCH_SYSTEM_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSystemThread<span class="token punctuation">.</span><span class="token function">installSystemApplicationInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ProcessRecord app <span class="token operator">=</span> <span class="token function">newProcessRecordLocked</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> info<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>persistent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>pid <span class="token operator">=</span> MY_PID<span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>maxAdj <span class="token operator">=</span> ProcessList<span class="token punctuation">.</span>SYSTEM_ADJ<span class="token punctuation">;</span>
                app<span class="token punctuation">.</span><span class="token function">makeActive</span><span class="token punctuation">(</span>mSystemThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityManagerNative<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton<span class="token operator">&lt;</span>IActivityManager<span class="token operator">></span> gDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token operator">&lt;</span>IActivityManager<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> IActivityManager <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h2><blockquote>
<p>AIDL ( Android Interface Definition Language ) Android 接口定义语言  </p>
</blockquote>
<p>通过查看 AIDL 生成的 Java 代码可以看出 AIDL 只是 Google 为了简化开发者编写 Binder 进程通信代码搞出来的一套东西，其实可以看出前面的 Binder 示例代码中有很大一部分是模板代码，变化的只是功能接口的定义和实现，所以现在只需要定义一个功能接口的 AIDL 文件，编译器会自动帮我们生成代理类 Proxy 和原始类 Stub，我们只需要再实现原始类 Stub 中定义好的接口功能方法就行了。<br>之后一般我们会借助 Service 类来完成整个跨进程通信，这其实是一种匿名 Binder 通信过程，因为我们并没有注册该服务，而是借助 Service 实名 Binder(ActivityManangerService) 来承载的，API 26 以后系统隐藏了 ServiceManager，我们不能直接拿到 ServiceManager 来完成注册和获取了，这时我们就可以通过这种已经注册好的实名 Binder 来承载我们自定义的匿名 Binder 完成通信。</p>
<p><img src="/img/aidl.png" alt=""></p>
<h2 id="ContentProvider"><a href="#ContentProvider" class="headerlink" title="ContentProvider"></a>ContentProvider</h2><p>ContentProvider 内容提供者，顾名思义这是一个数据提供功能的封装，在 Android 平台上不同应用间或者同一个应用中经常会有数据共享的需求，这就需要进程通信了，进程通信可以用 Binder 搞定，我们可以按照通用步骤：定义接口，注册服务，然后向外界暴露服务标识符，通过标识符来获取服务来实现或者简单点用 AIDL 来搞定，为什么要搞出一个 ContentProvider 呢？在我看来主要有两点：</p>
<ul>
<li><p><strong>统一规范</strong><br>ContentProvider 中定义了数据增，删，改，查操作的抽象方法，我们可以通过继承 ContentProvider 来完成具体的实现，试想如果没有这一套标准，通过AIDL 不同应用定义的数据共享操作接口方法各不相同，调用方还需要拷贝其接口文件完成转换调用，每需要访问另外一个应用或者进程的数据就需要拷贝一份 AIDL文件，这里就耦合了服务端的接口定义，有了 ContentProvider 了之后所有调用方不需要知道服务端的具体接口定义（因为统一了标准），直接使用其增，删，改，查方法即可，如果操作的数据结构相同，调用方调用不同服务端时还可以复用同一份调用代码。  </p>
</li>
<li><p><strong>抽象封装，简化代码</strong><br>AIDL 是一种功能无关的进程通信方式，数据共享操作只是其中的一种特定功能的操作，所以我们抽象出了里面的增，删，改，查四种操作，单一其职责，使其只负责共享数据的这四种操作，其它操作不提供，那客户端怎么找到我们在服务端基于此接口的具体实现呢？这里通过 Uri 来定位，客户端只需要调用 ContentResolver 传入 uri 来进行调用，简单高效，如调用系统通讯录：</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> cursor <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ContactsContract<span class="token punctuation">.</span>Contacts<span class="token punctuation">.</span>CONTENT_URI<span class="token punctuation">,</span>
              <span class="token function">arrayOf</span><span class="token punctuation">(</span>ContactsContract<span class="token punctuation">.</span>Contacts<span class="token punctuation">.</span>_ID<span class="token punctuation">,</span>
                      ContactsContract<span class="token punctuation">.</span>Contacts<span class="token punctuation">.</span>DISPLAY_NAME<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">moveToNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> long <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> name <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
          Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token string">"<span class="token interpolation variable">$long</span>-<span class="token interpolation variable">$name</span>"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
<p>实现层面 ContentProvider 同样是借助 ActivityManagerService 来完成跨进程通信的，由于采用是匿名Binder（为什么会采用这种匿名方式而不是直接采用注册到 Service，省去与系统 ContentProvider 容器通信的这一步的原因我也不太明白，难道是为了保证 ServiceManager 里面 Service 的纯正和大小？）, 需要一个系统级别的类似于 ServiceManager 的东西来管理所有注册的 ContentProvider，所以就有了 ContentResolver，首先通过与系统进程通信拿到匹配的ContentProvider,然后与 ContentProvider 所在进程进行通信执行对应的增、删、改、查方法，具体的代码调用流程感兴趣的可以跟踪下源码，这里就不再说了。</p>
<p><strong>一次Query流程图</strong></p>
<p><img src="/img/get_content_provider.jpg" alt=""></p>
<h2 id="BroadcastReceiver"><a href="#BroadcastReceiver" class="headerlink" title="BroadcastReceiver"></a>BroadcastReceiver</h2><p>广播是一种一对多的进程通信方式，一个调用方调用多个被调用方，而文章前面涉及到的都是多个客户端（调用方）调用同一个服务端（被调用方）的多对一的通信方式，要做到这种一对多的通信方式必须在上层进行封装，也就是我们常见的观察者模式，服务端首先注册接收器到系统的某个容器中（BroadcastRecord，里面包含一个有序接收器队列和一个并行接收器队列），客户端发送请求时通过与系统的进程通信在这个系统容器中查找其所有适配的接收器，然后再通过进程通信执行所匹配到的所有接收器所在进程对应的观察方法，其中的第一次进程通信是依赖 ActivityManagerService 的进程通信，第二次是 IIntentReceiver 匿名 Binder 进程通信，大概流程如下图，感兴趣的可以自行跟踪源码。</p>
<p><img src="/img/send_broadcast.jpg" alt=""></p>
<h2 id="Messenger"><a href="#Messenger" class="headerlink" title="Messenger"></a>Messenger</h2><p>Messenger 顾名思义是一种基于消息的通信方式，特点是通信双方可以相互发消息进行通信，而 Binder 通信是单向的，谁发起请求谁就是客户端，谁接收请求谁就是服务端，要想实现双向通信必须接收方可以持有对方的引用再反向通信调用方，一个简单的方法就是使用 Binder 承载匿名 Binder 的方式：在第一次进程通信的时候，传输一个 Binder 给服务端，服务端再拿到这个客户端的代理 Binder，再反向通信从而完成双向通信，Messenger 就是简化这一套操作抽象出来的东西，IMessenger.Stub 就是有消息发送能力的接口 Binder，由于 Messenger 发送消息采用了 handler 中向应用主线程消息队列中 sendMessage 的实现方式，所以这个远程进程通信过程是异步的（通信后立即返回，不必等到这个消息的处理逻辑过程的完成），串行的（多个客服端向服务端发消息时，都会发送到服务端的消息队列中等待主线程顺序执行），同样第一次通信过程一般采用 Service 来进行进程通信，在 Service 中返回 Messenger 对象，而这个 Messenger 对象发送消息 Message 时又可以携带一个回执 Messenger（Message.replyTo），这样就可以实现双方一直双向通信了。<br><img src="/img/messenger.png" alt=""></p>
<h1 id="Activity-启动流程"><a href="#Activity-启动流程" class="headerlink" title="Activity 启动流程"></a>Activity 启动流程</h1><p>Activity 是一个用来和用户交互的 UI 抽象类，其中封装了视图、交互事件，由于视图、事件都是系统底层的资源所以需要与系统进行进程通信，同时 Activity 与四大组件间也需要通信，Activity 是我们开发中经常用到的类，所以理解它十分重要。<br>首先我们来看一下通信双方的 Binder 接口定义：Activity 调用系统进程中的 ActivityService 服务的 Binder 接口为 <strong><code>ActivityServiceNative</code></strong>，系统进程完成一些资源的创建后需要回调应用进程，这个过程的通信 Binder 接口为 <strong><code>ApplicationThreadNative</code></strong> ，虽然这两个接口的定义的方法很多，但大体上就是四大组件的启动方法和对应的生命周期方法。下面我们来具体跟踪下 Activity 的启动过程源码。</p>
<h2 id="用户-App-进程"><a href="#用户-App-进程" class="headerlink" title="用户 App 进程"></a>用户 App 进程</h2><p>在 <code>Activity</code>中调用 <code>startActivity</code> 经过一些重载方法后最终会调用到 <code>startActivityForResult</code></p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>Activity<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> Bundle options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options <span class="token operator">=</span> <span class="token function">transferSpringboardActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Instrumentation<span class="token punctuation">.</span>ActivityResult ar <span class="token operator">=</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                    intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">sendActivityResult</span><span class="token punctuation">(</span>
                    mToken<span class="token punctuation">,</span> mEmbeddedID<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> ar<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    ar<span class="token punctuation">.</span><span class="token function">getResultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mStartedActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">cancelInputsAndStartExitTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这里的两个分支最终都会调用 <code>mInstrumentation.execStartActivity()</code>，这个 <code>mInstrumentation</code> 对象非常重要，后面很多操作都需要它来完成，关于它是什么，在何时何地被创建，有什么作用，后来会介绍，我们继续来跟踪</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>Instrumentation<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> ActivityResult <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
            Context who<span class="token punctuation">,</span> IBinder contextThread<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> Activity target<span class="token punctuation">,</span>
            Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> Bundle options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IApplicationThread whoThread <span class="token operator">=</span> <span class="token punctuation">(</span>IApplicationThread<span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
        Uri referrer <span class="token operator">=</span> target <span class="token operator">!=</span> null <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">onProvideReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>referrer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">,</span> referrer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> ActivityMonitor am <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> null<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> requestCode <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> am<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//获取AMN代理Binder进行进程通信</span>
                <span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                        intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        token<span class="token punctuation">,</span> target <span class="token operator">!=</span> null <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> null<span class="token punctuation">,</span>
                        requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failure from system"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这里会调用 <code>ActivityManagerNative.getDefault().startActivity()</code>，返回值为一个 int 值类型结果码用来确定结果，<code>checkStartActivityResult</code> 方法中会根据返回的结果码匹配抛出对应的异常，这里就有我们常见的 “ <strong>找到不对应的Activity错误</strong> ”，<code>ActivityManagerNative.getDefault()</code> 是一个 <code>ActivityManagerService</code> 本地代理单例</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityManagerNative<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton<span class="token operator">&lt;</span>IActivityManager<span class="token operator">></span> gDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token operator">&lt;</span>IActivityManager<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> IActivityManager <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>从这里开始就要进行进程通信了</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityManagerProxy<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>IApplicationThread var1<span class="token punctuation">,</span> String var2<span class="token punctuation">,</span> Intent var3<span class="token punctuation">,</span> String var4<span class="token punctuation">,</span> IBinder var5<span class="token punctuation">,</span> String var6<span class="token punctuation">,</span> <span class="token keyword">int</span> var7<span class="token punctuation">,</span> <span class="token keyword">int</span> var8<span class="token punctuation">,</span> ProfilerInfo var9<span class="token punctuation">,</span> Bundle var10<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        Parcel var11 <span class="token operator">=</span> Parcel<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Parcel var12 <span class="token operator">=</span> Parcel<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 打包输入参数数据</span>
        var11<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token string">"android.app.IActivityManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        IBinder var13<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var1 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            var13 <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            var13 <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        var11<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>var13<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var3<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>var11<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>var5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>var7<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>var8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var9 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            var11<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            var9<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>var11<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            var11<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>var10 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            var11<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            var10<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>var11<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            var11<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Binder 进程通信 </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> var11<span class="token punctuation">,</span> var12<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment" spellcheck="true">//解析返回数据</span>
        var12<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var7 <span class="token operator">=</span> var12<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var12<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var11<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> var7<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>依然是对一些参数的包装，并调用<strong><code>this.mRemote.transact(3, var11, var12, 0)</code></strong> 进行进程通信，最终会调用到 <strong><code>ActivityManagerNative.onTransact()</code></strong> 方法进入 <code>ActivityManagerService</code> 服务进程</p>
<h2 id="ActivityManagerService-服务进程"><a href="#ActivityManagerService-服务进程" class="headerlink" title="ActivityManagerService 服务进程"></a>ActivityManagerService 服务进程</h2><p>从这里就进入到 <code>ActivityManagerService</code> 服务进程的部分了，我们继续追踪：</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityManagerService<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> Parcel data<span class="token punctuation">,</span> Parcel reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> START_ACTIVITY_TRANSACTION<span class="token operator">:</span>
        <span class="token punctuation">{</span>
            data<span class="token punctuation">.</span><span class="token function">enforceInterface</span><span class="token punctuation">(</span>IActivityManager<span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            IBinder b <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            IApplicationThread app <span class="token operator">=</span> ApplicationThreadNative<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取与 App 用户进程通信的 Binder</span>
            String callingPackage <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Intent intent <span class="token operator">=</span> Intent<span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String resolvedType <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            IBinder resultTo <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String resultWho <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> requestCode <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> startFlags <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ProfilerInfo profilerInfo <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                    <span class="token operator">?</span> ProfilerInfo<span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            Bundle options <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                    <span class="token operator">?</span> Bundle<span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            reply<span class="token punctuation">.</span><span class="token function">writeNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            reply<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>根据 code 为 3 匹配到 START_ACTIVITY_TRANSACTION 分支，进行一些数据解析，其中 <code>IApplicationThread app = ApplicationThreadNative.asInterface(b)</code> 取得与应用进程通信的 Binder 对象，为后面的与用户 App 进程通信做支持，然后调用 <code>startActivity</code> 方法，辗转后调用 <code>ActivityStarter.startActivityMayWait()</code> 方法</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityStarter<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivityMayWait</span><span class="token punctuation">(</span>IApplicationThread caller<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> String callingPackage<span class="token punctuation">,</span> Intent intent<span class="token punctuation">,</span> String resolvedType<span class="token punctuation">,</span> IVoiceInteractionSession voiceSession<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span> IBinder resultTo<span class="token punctuation">,</span> String resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> ProfilerInfo profilerInfo<span class="token punctuation">,</span> WaitResult outResult<span class="token punctuation">,</span> Configuration config<span class="token punctuation">,</span> Bundle options<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ignoreTargetSecurity<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> IActivityContainer iContainer<span class="token punctuation">,</span> TaskRecord inTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">//创建新的Intent对象，即便intent被修改也不受影响</span>
    intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//收集Intent所指向的Activity信息, 当存在多个可供选择的Activity,则直接向用户弹出resolveActivity</span>
    ResolveInfoActivityInfo aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ActivityStackSupervisor<span class="token punctuation">.</span>ActivityContainer container <span class="token operator">=</span> <span class="token punctuation">(</span>ActivityStackSupervisor<span class="token punctuation">.</span>ActivityContainer<span class="token punctuation">)</span>iContainer<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">//something not important</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">startActivityLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> ephemeralIntent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    aInfo<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                    resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span>
                    callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
                    options<span class="token punctuation">,</span> ignoreTargetSecurity<span class="token punctuation">,</span> componentSpecified<span class="token punctuation">,</span> outRecord<span class="token punctuation">,</span> container<span class="token punctuation">,</span>
                    inTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>会通过 <code>resolveActivity</code> 来获取 <code>ActivityInfo</code> 信息 , 换句话来说就是会检查系统中所有安装了的 App 中是否有该 Intent 的目标 Activity 被注册（ Manifests 文件中注册）然后再进入 <code>ActivityStarter.startActivityLocked()</code>，接下来的调用链分支比较多，大多逻辑是根据 Activity 的四种启动模式来执行不同的逻辑块，我们选取正常的分支: 启动模式为 Normal，启动的 Activity 与现在 Activity 不同且在同一个栈中的情况来跟踪，调用链为:<br> -&gt; <code>ActivityStarter.startActivityUnchecked()</code><br> -&gt; <code>ActivityStarter.resumeTargetStackIfNeeded()</code><br> -&gt; <code>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</code><br> -&gt; <code>ActivityStack.resumeTopActivityUncheckedLocked()</code><br> -&gt; <code>ActivityStack.resumeTopActivityInnerLocked()</code> </p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityStack<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>ActivityRecord prev<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">//系统没有进入booting或booted状态，则不允许启动Activity</span>

        <span class="token comment" spellcheck="true">//需要等待暂停当前activity完成，再resume top activity</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> dontWaitForPause <span class="token operator">=</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> FLAG_RESUME_WHILE_PAUSING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//暂停其他Activity</span>
        <span class="token keyword">boolean</span> pausing <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">pauseBackStacks</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> next<span class="token punctuation">,</span> dontWaitForPause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                    <span class="token string">"resumeTopActivityLocked: Pausing "</span> <span class="token operator">+</span> mResumedActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前resumd状态activity不为空，则需要先暂停该Activity</span>
            pausing <span class="token operator">|=</span> <span class="token function">startPausingLocked</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> dontWaitForPause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pausing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH <span class="token operator">||</span> DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                    <span class="token string">"resumeTopActivityLocked: Skip resume: need to start pausing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//更新目标Activity进程 LruCache</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">==</span> next <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>state <span class="token operator">==</span> ActivityState<span class="token punctuation">.</span>RESUMED <span class="token operator">&amp;&amp;</span>
                mStackSupervisor<span class="token punctuation">.</span><span class="token function">allResumedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果下一个Activity不需要等待暂停完成，那么当我们暂停上面的堆栈时，就可以恢复Activity。所以，除了确保我们已经执行了任何挂起的 Transition，因为在这一点上应该没有任何事情要做。</span>
            mWindowManager<span class="token punctuation">.</span><span class="token function">executeAppTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mNoAnimActivities<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ActivityOptions<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                    <span class="token string">"resumeTopActivityLocked: Top activity resumed (dontWaitForPause) "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// If the most recent activity was noHistory but was only stopped rather</span>
        <span class="token comment" spellcheck="true">// than stopped+finished because the device went to sleep, we need to make</span>
        <span class="token comment" spellcheck="true">// sure to finish it as we're making a new activity topmost.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">isSleepingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mLastNoHistoryActivity <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>mLastNoHistoryActivity<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                    <span class="token string">"no-history finish of "</span> <span class="token operator">+</span> mLastNoHistoryActivity <span class="token operator">+</span> <span class="token string">" on new resume"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>mLastNoHistoryActivity<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span>
                    null<span class="token punctuation">,</span> <span class="token string">"resume-no-history"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLastNoHistoryActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!=</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStackSupervisor<span class="token punctuation">.</span>mWaitingVisibleActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> next <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mStackSupervisor<span class="token punctuation">.</span>mWaitingVisibleActivities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_SWITCH<span class="token punctuation">,</span>
                        <span class="token string">"Resuming top, waiting visible to hide: "</span> <span class="token operator">+</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//隐藏上一个Activity的窗口</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mWindowManager<span class="token punctuation">.</span><span class="token function">setAppVisibility</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_SWITCH<span class="token punctuation">,</span>
                            <span class="token string">"Not waiting for visible to hide: "</span> <span class="token operator">+</span> prev <span class="token operator">+</span> <span class="token string">", waitingVisible="</span>
                            <span class="token operator">+</span> mStackSupervisor<span class="token punctuation">.</span>mWaitingVisibleActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">", nowVisible="</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_SWITCH<span class="token punctuation">,</span>
                            <span class="token string">"Previous already visible but still waiting to hide: "</span> <span class="token operator">+</span> prev
                            <span class="token operator">+</span> <span class="token string">", waitingVisible="</span>
                            <span class="token operator">+</span> mStackSupervisor<span class="token punctuation">.</span>mWaitingVisibleActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">", nowVisible="</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>nowVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// 通过 WindowManager 隐藏上一个 Activity</span>
        <span class="token keyword">boolean</span> anim <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TRANSITION<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TRANSITION<span class="token punctuation">,</span>
                        <span class="token string">"Prepare close transition: prev="</span> <span class="token operator">+</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    anim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>TRANSIT_NONE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>task <span class="token operator">==</span> next<span class="token punctuation">.</span>task
                            <span class="token operator">?</span> TRANSIT_ACTIVITY_CLOSE
                            <span class="token operator">:</span> TRANSIT_TASK_CLOSE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mWindowManager<span class="token punctuation">.</span><span class="token function">setAppVisibility</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TRANSITION<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TRANSITION<span class="token punctuation">,</span>
                        <span class="token string">"Prepare open transition: prev="</span> <span class="token operator">+</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    anim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>TRANSIT_NONE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>task <span class="token operator">==</span> next<span class="token punctuation">.</span>task
                            <span class="token operator">?</span> TRANSIT_ACTIVITY_OPEN
                            <span class="token operator">:</span> next<span class="token punctuation">.</span>mLaunchTaskBehind
                                    <span class="token operator">?</span> TRANSIT_TASK_OPEN_BEHIND
                                    <span class="token operator">:</span> TRANSIT_TASK_OPEN<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_TRANSITION<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_TRANSITION<span class="token punctuation">,</span> <span class="token string">"Prepare open transition: no previous"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mNoAnimActivities<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                anim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>TRANSIT_NONE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mWindowManager<span class="token punctuation">.</span><span class="token function">prepareAppTransition</span><span class="token punctuation">(</span>TRANSIT_ACTIVITY_OPEN<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        Bundle resumeAnimOptions <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityOptions opts <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getOptionsForTargetActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>opts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resumeAnimOptions <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">toBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            next<span class="token punctuation">.</span><span class="token function">applyOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">clearOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ActivityStack lastStack <span class="token operator">=</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">getLastStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_SWITCH<span class="token punctuation">,</span> <span class="token string">"Resume running: "</span> <span class="token operator">+</span> next
                    <span class="token operator">+</span> <span class="token string">" stopped="</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>stopped <span class="token operator">+</span> <span class="token string">" visible="</span> <span class="token operator">+</span> next<span class="token punctuation">.</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// If the previous activity is translucent, force a visibility update of</span>
            <span class="token comment" spellcheck="true">// the next activity, so that it's added to WM's opening app list, and</span>
            <span class="token comment" spellcheck="true">// transition animation can be set up properly.</span>
            <span class="token comment" spellcheck="true">// For example, pressing Home button with a translucent activity in focus.</span>
            <span class="token comment" spellcheck="true">// Launcher is already visible in this case. If we don't add it to opening</span>
            <span class="token comment" spellcheck="true">// apps, maybeUpdateTransitToWallpaper() will fail to identify this as a</span>
            <span class="token comment" spellcheck="true">// TRANSIT_WALLPAPER_OPEN animation, and run some funny animation.</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> lastActivityTranslucent <span class="token operator">=</span> lastStack <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastStack<span class="token punctuation">.</span>mFullscreen
                    <span class="token operator">||</span> <span class="token punctuation">(</span>lastStack<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lastStack<span class="token punctuation">.</span>mLastPausedActivity<span class="token punctuation">.</span>fullscreen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 使下个 Activity 为可见</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>visible <span class="token operator">||</span> next<span class="token punctuation">.</span>stopped <span class="token operator">||</span> lastActivityTranslucent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWindowManager<span class="token punctuation">.</span><span class="token function">setAppVisibility</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// schedule launch ticks to collect information about slow apps.</span>
            next<span class="token punctuation">.</span><span class="token function">startLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ActivityRecord lastResumedActivity <span class="token operator">=</span>
                    lastStack <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span>lastStack<span class="token punctuation">.</span>mResumedActivity<span class="token punctuation">;</span>
            ActivityState lastState <span class="token operator">=</span> next<span class="token punctuation">.</span>state<span class="token punctuation">;</span>

            mService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"Moving to RESUMED: "</span> <span class="token operator">+</span> next <span class="token operator">+</span> <span class="token string">" (in existing)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            next<span class="token punctuation">.</span>state <span class="token operator">=</span> ActivityState<span class="token punctuation">.</span>RESUMED<span class="token punctuation">;</span>
            mResumedActivity <span class="token operator">=</span> next<span class="token punctuation">;</span>
            next<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">touchActiveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRecentTasks<span class="token punctuation">.</span><span class="token function">addLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateLRUListLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Have the window manager re-evaluate the orientation of</span>
            <span class="token comment" spellcheck="true">// the screen based on the new activity order.</span>
            <span class="token keyword">boolean</span> notUpdated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">isFocusedStack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Configuration config <span class="token operator">=</span> mWindowManager<span class="token punctuation">.</span><span class="token function">updateOrientationFromAppTokens</span><span class="token punctuation">(</span>
                        mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">,</span>
                        next<span class="token punctuation">.</span><span class="token function">mayFreezeScreenLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token operator">?</span> next<span class="token punctuation">.</span>appToken <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span>frozenBeforeDestroy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                notUpdated <span class="token operator">=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">updateConfigurationLocked</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>notUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// The configuration update wasn't able to keep the existing</span>
                <span class="token comment" spellcheck="true">// instance of the activity, and instead started a new one.</span>
                <span class="token comment" spellcheck="true">// We should be all done, but let's just make sure our activity</span>
                <span class="token comment" spellcheck="true">// is still at the top and schedule another run if something</span>
                <span class="token comment" spellcheck="true">// weird happened.</span>
                ActivityRecord nextNext <span class="token operator">=</span> <span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH <span class="token operator">||</span> DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                        <span class="token string">"Activity config changed during resume: "</span> <span class="token operator">+</span> next
                        <span class="token operator">+</span> <span class="token string">", new next: "</span> <span class="token operator">+</span> nextNext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextNext <span class="token operator">!=</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Do over!</span>
                    mStackSupervisor<span class="token punctuation">.</span><span class="token function">scheduleResumeTopActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span><span class="token function">reportResumedActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mNoAnimActivities<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Deliver all pending results.</span>
                ArrayList<span class="token operator">&lt;</span>ResultInfo<span class="token operator">></span> a <span class="token operator">=</span> next<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>finishing <span class="token operator">&amp;&amp;</span> N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_RESULTS<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_RESULTS<span class="token punctuation">,</span>
                                <span class="token string">"Delivering results to "</span> <span class="token operator">+</span> next <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 分发 ActivityResult 即我们常见的 onActivityResult        </span>
                        next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleSendResult</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">boolean</span> allowSavedSurface <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>newIntents <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Restrict saved surface to launcher start, or there is no intent at all</span>
                    <span class="token comment" spellcheck="true">// (eg. task being brought to front). If the intent is something else,</span>
                    <span class="token comment" spellcheck="true">// likely the app is going to show some specific page or view, instead of</span>
                    <span class="token comment" spellcheck="true">// what's left last time.</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> next<span class="token punctuation">.</span>newIntents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> next<span class="token punctuation">.</span>newIntents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ActivityRecord<span class="token punctuation">.</span><span class="token function">isMainIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            allowSavedSurface <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleNewIntent</span><span class="token punctuation">(</span>
                            next<span class="token punctuation">.</span>newIntents<span class="token punctuation">,</span> next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* andPause */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// Well the app will no longer be stopped.</span>
                <span class="token comment" spellcheck="true">// Clear app token stopped state in window manager if needed.</span>
                mWindowManager<span class="token punctuation">.</span><span class="token function">notifyAppResumed</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> next<span class="token punctuation">.</span>stopped<span class="token punctuation">,</span> allowSavedSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>

                EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>AM_RESUME_ACTIVITY<span class="token punctuation">,</span> next<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span>task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> next<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                next<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">showUnsupportedZoomDialogIfNeededLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">showAskCompatModeDialogLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pendingUiClean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mTopProcessState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">clearOptionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleResumeActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> next<span class="token punctuation">.</span>app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span>
                        mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resumeAnimOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mStackSupervisor<span class="token punctuation">.</span><span class="token function">checkReadyForSleepLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"resumeTopActivityLocked: Resumed "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Whoops, need to restart this activity!</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"Resume failed; resetting state to "</span>
                        <span class="token operator">+</span> lastState <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span>state <span class="token operator">=</span> lastState<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lastStack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lastStack<span class="token punctuation">.</span>mResumedActivity <span class="token operator">=</span> lastResumedActivity<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Restarting because process died: "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>hasBeenLaunched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span>hasBeenLaunched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_APP_STARTING_PREVIEW <span class="token operator">&amp;&amp;</span> lastStack <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                        mStackSupervisor<span class="token punctuation">.</span><span class="token function">isFrontStack</span><span class="token punctuation">(</span>lastStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// From this point on, if something goes wrong there is no way</span>
            <span class="token comment" spellcheck="true">// to recover the activity.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">completeResumeLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// If any exception gets thrown, toss away this</span>
                <span class="token comment" spellcheck="true">// activity and try the next one.</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception thrown during resume of "</span> <span class="token operator">+</span> next<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        <span class="token string">"resume-exception"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Whoops, need to restart this activity!</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>hasBeenLaunched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span>hasBeenLaunched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>SHOW_APP_STARTING_PREVIEW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">showStartingWindow</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_SWITCH<span class="token punctuation">,</span> <span class="token string">"Restarting: "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">"resumeTopActivityLocked: Restarting "</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 启动一个新的 Activity</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STACK<span class="token punctuation">)</span> mStackSupervisor<span class="token punctuation">.</span><span class="token function">validateTopActivitiesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这段代码比较多，主要逻辑是先暂停和隐藏栈中的 Activity，其中涉及到与 App 用户进程通信（暂停 Activity ）和与 <code>WindowManagerService</code> 所在进程通信（隐藏前面的 Activity 窗口）然后调用 <code>mStackSupervisor.startSpecificActivityLocked</code> 启动一个新的 Activity</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityStackSupervisor<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">void</span> <span class="token function">startSpecificActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        r<span class="token punctuation">.</span>task<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">setLaunchTime</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 该Activity所在进程已经在运行？如果有就直接启动，没有则与系统进程通信 fork出一个新的进程用来运行 Activity</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ActivityInfo<span class="token punctuation">.</span>FLAG_MULTIPROCESS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                        <span class="token operator">||</span> <span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Don't add this if it is a platform component that is marked</span>
                    <span class="token comment" spellcheck="true">// to run in multiple processes, because this is actually</span>
                    <span class="token comment" spellcheck="true">// part of the framework so doesn't make sense to track as a</span>
                    <span class="token comment" spellcheck="true">// separate apk in the process.</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span>
                            mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception when starting activity "</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// If a dead object exception was thrown -- fall through to</span>
            <span class="token comment" spellcheck="true">// restart the application.</span>
        <span class="token punctuation">}</span>

        mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"activity"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这里有两个分支，第一个是当前 Activity 所在 app 进程没有启动，这个时候会与系统进程进行通信 fork 出一个新的进程，在新进程 main 函数中调用 <code>ActivityManagerProxy.attachApplication</code> 进行进程通信，最终会调用<code>ActivityStackSupervisor.attachApplicationLocked</code></p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityStackSupervisor<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String processName <span class="token operator">=</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ArrayList<span class="token operator">&lt;</span>ActivityStack<span class="token operator">></span> stacks <span class="token operator">=</span> mActivityDisplays<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">.</span>mStacks<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stackNdx <span class="token operator">=</span> stacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> stackNdx <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>stackNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> stacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>stackNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFocusedStack</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ActivityRecord hr <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hr<span class="token punctuation">.</span>app <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>uid <span class="token operator">==</span> hr<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                            <span class="token operator">&amp;&amp;</span> processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>hr<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>hr<span class="token punctuation">,</span> app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//又回到之前已经有进程的分支了</span>
                                didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Exception in new application when starting activity "</span>
                                  <span class="token operator">+</span> hr<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didSomething<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensureActivitiesVisibleLocked</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">!</span>PRESERVE_WINDOWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>可以看出这里会调用 realStartActivityLocked 方法，即回到我们前面所说的第二条分支:当 Activity 所声明进程已经存在的情况</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityStackSupervisor<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>ActivityRecord r<span class="token punctuation">,</span> ProcessRecord app<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allPausedActivitiesComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//如果还有Activity没有完成暂停，就先跳过启动新的Activity</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">startFreezingScreenLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mWindowManager<span class="token punctuation">.</span><span class="token function">setAppVisibility</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// schedule launch ticks to collect information about slow apps.</span>
            r<span class="token punctuation">.</span><span class="token function">startLaunchTickingLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Have the window manager re-evaluate the orientation of</span>
        <span class="token comment" spellcheck="true">// the screen based on the new activity order.  Note that</span>
        <span class="token comment" spellcheck="true">// as a result of this, it can call back into the activity</span>
        <span class="token comment" spellcheck="true">// manager with a new orientation.  We don't care about that,</span>
        <span class="token comment" spellcheck="true">// because the activity is not currently running so we are</span>
        <span class="token comment" spellcheck="true">// just restarting it anyway.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Configuration config <span class="token operator">=</span> mWindowManager<span class="token punctuation">.</span><span class="token function">updateOrientationFromAppTokens</span><span class="token punctuation">(</span>
                    mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span><span class="token function">mayFreezeScreenLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>appToken <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Deferring resume here because we're going to launch new activity shortly.</span>
            <span class="token comment" spellcheck="true">// We don't want to perform a redundant launch of the same record while ensuring</span>
            <span class="token comment" spellcheck="true">// configurations and trying to resume top activity of focused stack.</span>
            mService<span class="token punctuation">.</span><span class="token function">updateConfigurationLocked</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* deferResume */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>app <span class="token operator">=</span> app<span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>waitingToKill <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>launchCount<span class="token operator">++</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>lastLaunchTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_ALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Launching: "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> idx <span class="token operator">=</span> app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> TaskRecord task <span class="token operator">=</span> r<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>mLockTaskAuth <span class="token operator">==</span> LOCK_TASK_AUTH_LAUNCHABLE <span class="token operator">||</span>
                task<span class="token punctuation">.</span>mLockTaskAuth <span class="token operator">==</span> LOCK_TASK_AUTH_LAUNCHABLE_PRIV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setLockTaskModeLocked</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> LOCK_TASK_MODE_LOCKED<span class="token punctuation">,</span> <span class="token string">"mLockTaskAuth==LAUNCHABLE"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> ActivityStack stack <span class="token operator">=</span> task<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            List<span class="token operator">&lt;</span>ResultInfo<span class="token operator">></span> results <span class="token operator">=</span> null<span class="token punctuation">;</span>
            List<span class="token operator">&lt;</span>ReferrerIntent<span class="token operator">></span> newIntents <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                results <span class="token operator">=</span> r<span class="token punctuation">.</span>results<span class="token punctuation">;</span>
                newIntents <span class="token operator">=</span> r<span class="token punctuation">.</span>newIntents<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SWITCH<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_SWITCH<span class="token punctuation">,</span>
                    <span class="token string">"Launching: "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" icicle="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>icicle <span class="token operator">+</span> <span class="token string">" with results="</span> <span class="token operator">+</span> results
                    <span class="token operator">+</span> <span class="token string">" newIntents="</span> <span class="token operator">+</span> newIntents <span class="token operator">+</span> <span class="token string">" andResume="</span> <span class="token operator">+</span> andResume<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>AM_RESTART_ACTIVITY<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        task<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> r<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isHomeActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Home process is the root process of the task.</span>
                mService<span class="token punctuation">.</span>mHomeProcess <span class="token operator">=</span> task<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>app<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_ACTIVITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>forceNewConfig <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">showUnsupportedZoomDialogIfNeededLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">showAskCompatModeDialogLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>compat <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ProfilerInfo profilerInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProfileApp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mProfileApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProfileProc <span class="token operator">==</span> null <span class="token operator">||</span> mService<span class="token punctuation">.</span>mProfileProc <span class="token operator">==</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mService<span class="token punctuation">.</span>mProfileProc <span class="token operator">=</span> app<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> String profileFile <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProfileFile<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>profileFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ParcelFileDescriptor profileFd <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProfileFd<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>profileFd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                profileFd <span class="token operator">=</span> profileFd<span class="token punctuation">.</span><span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>profileFd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                        profileFd<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token punctuation">}</span>
                                    profileFd <span class="token operator">=</span> null<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        profilerInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProfilerInfo</span><span class="token punctuation">(</span>profileFile<span class="token punctuation">,</span> profileFd<span class="token punctuation">,</span>
                                mService<span class="token punctuation">.</span>mSamplingInterval<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mAutoStopProfiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                app<span class="token punctuation">.</span>hasShownUi <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                app<span class="token punctuation">.</span>pendingUiClean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//将该进程设置为前台进程PROCESS_STATE_TOP</span>
            app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mTopProcessState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 与 app 用户进程进行通信，启动Activity</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleLaunchActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span>
                    System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mConfiguration<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mOverrideConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span> r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">,</span>
                    task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">,</span> r<span class="token punctuation">.</span>icicle<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">,</span> results<span class="token punctuation">,</span>
                    newIntents<span class="token punctuation">,</span> <span class="token operator">!</span>andResume<span class="token punctuation">,</span> mService<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> profilerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>privateFlags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_CANT_SAVE_STATE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// This may be a heavy-weight process!  Note that the package</span>
                <span class="token comment" spellcheck="true">// manager will ensure that only activity can run in the main</span>
                <span class="token comment" spellcheck="true">// process of the .apk, which is the only thing that will be</span>
                <span class="token comment" spellcheck="true">// considered heavy-weight.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">!=</span> null
                            <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">!=</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting new heavy weight process "</span> <span class="token operator">+</span> app
                                <span class="token operator">+</span> <span class="token string">" when already running "</span>
                                <span class="token operator">+</span> mService<span class="token punctuation">.</span>mHeavyWeightProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mService<span class="token punctuation">.</span>mHeavyWeightProcess <span class="token operator">=</span> app<span class="token punctuation">;</span>
                    Message msg <span class="token operator">=</span> mService<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
                            ActivityManagerService<span class="token punctuation">.</span>POST_HEAVY_NOTIFICATION_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> r<span class="token punctuation">;</span>
                    mService<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>launchFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//第二次启动失败，则结束该activity</span>
                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Second failure launching "</span>
                      <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token operator">+</span> <span class="token string">", giving up"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mService<span class="token punctuation">.</span><span class="token function">appDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stack<span class="token punctuation">.</span><span class="token function">requestFinishActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>appToken<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        <span class="token string">"2nd-crash"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//这是第一个启动失败，则重启进程重试</span>
            app<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span>launchFailed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">updateLRUListLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Activity "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" being launched, but already in LRU list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// As part of the process of launching, ActivityThread also performs</span>
            <span class="token comment" spellcheck="true">// a resume.</span>
            stack<span class="token punctuation">.</span><span class="token function">minimalResumeActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// This activity is not starting in the resumed state... which should look like we asked</span>
            <span class="token comment" spellcheck="true">// it to pause+stop (but remain visible), and it has done so and reported back the</span>
            <span class="token comment" spellcheck="true">// current icicle and other state.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                    <span class="token string">"Moving to PAUSED: "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" (starting in paused state)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> PAUSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Launch the new version setup screen if needed.  We do this -after-</span>
        <span class="token comment" spellcheck="true">// launching the initial activity (that is, home), so that it can have</span>
        <span class="token comment" spellcheck="true">// a chance to initialize itself while in the background, making the</span>
        <span class="token comment" spellcheck="true">// switch back to it faster and look better.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFocusedStack</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">startSetupActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Update any services we are bound to that might care about whether</span>
        <span class="token comment" spellcheck="true">// their client may have activities.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span>mServices<span class="token punctuation">.</span><span class="token function">updateServiceConnectionActivitiesLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>接着就利用 ApplicationThreadProxy 与 app 用户进程进行通信，进入到 app 用户端进程</p>
<h2 id="用户-App-进程-1"><a href="#用户-App-进程-1" class="headerlink" title="用户 App 进程"></a>用户 App 进程</h2><pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityThread<span class="token punctuation">.</span>ApplicationThread<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleLaunchActivity</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> IBinder token<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span>
                ActivityInfo info<span class="token punctuation">,</span> Configuration curConfig<span class="token punctuation">,</span> Configuration overrideConfig<span class="token punctuation">,</span>
                CompatibilityInfo compatInfo<span class="token punctuation">,</span> String referrer<span class="token punctuation">,</span> IVoiceInteractor voiceInteractor<span class="token punctuation">,</span>
                <span class="token keyword">int</span> procState<span class="token punctuation">,</span> Bundle state<span class="token punctuation">,</span> PersistableBundle persistentState<span class="token punctuation">,</span>
                List<span class="token operator">&lt;</span>ResultInfo<span class="token operator">></span> pendingResults<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>ReferrerIntent<span class="token operator">></span> pendingNewIntents<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> notResumed<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isForward<span class="token punctuation">,</span> ProfilerInfo profilerInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>procState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ActivityClientRecord r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>ident <span class="token operator">=</span> ident<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>intent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>referrer <span class="token operator">=</span> referrer<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>voiceInteractor <span class="token operator">=</span> voiceInteractor<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>persistentState <span class="token operator">=</span> persistentState<span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>pendingResults <span class="token operator">=</span> pendingResults<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>pendingIntents <span class="token operator">=</span> pendingNewIntents<span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>startsNotResumed <span class="token operator">=</span> notResumed<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>isForward <span class="token operator">=</span> isForward<span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>profilerInfo <span class="token operator">=</span> profilerInfo<span class="token punctuation">;</span>

            r<span class="token punctuation">.</span>overrideConfig <span class="token operator">=</span> overrideConfig<span class="token punctuation">;</span>
            <span class="token function">updatePendingConfiguration</span><span class="token punctuation">(</span>curConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>LAUNCH_ACTIVITY<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接着调用 <code>sendMessage</code> 向主线程消息队列中发送启动 Activity 的消息，辗转到 Handler的 <code>handleMessage</code> 方法中，其中 H 为 ActivityThread 主线程中的 Handler子类，在主线程被创建的时候创建，在 <code>handleMessage</code> 中会调用<br><code>handleLaunchActivity</code></p>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityThread<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>profilerInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mProfiler<span class="token punctuation">.</span><span class="token function">setProfiler</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>profilerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProfiler<span class="token punctuation">.</span><span class="token function">startProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//最终回调目标Activity的onConfigurationChanged()</span>
        <span class="token function">handleConfigurationChanged</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 在创建Activity之前初始化 WMG</span>
        WindowManagerGlobal<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//最终会调用目标Activity的onCreate</span>
        Activity a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>createdConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>mConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reportSizeConfigurations</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Bundle oldState <span class="token operator">=</span> r<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//最终会调用目标Activity的onStart,onResume.</span>
            <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>isForward<span class="token punctuation">,</span>
                    <span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastProcessedSeq<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//如果Activity 没有销毁且不在活动状态 则暂停该Activity</span>
                <span class="token function">performPauseActivityIfNeeded</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPreHoneycomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//如果有错误就停掉Activity</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">finishActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>token<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                            Activity<span class="token punctuation">.</span>DONT_FINISH_TASK_WITH_ACTIVITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span>ActivityThread<span class="token punctuation">.</span>java<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token keyword">private</span> Activity <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>ActivityClientRecord r<span class="token punctuation">,</span> Intent customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        Activity activity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                    cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//创建 Activity</span>
            StrictMode<span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Application app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取Application</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Context appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> activity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//创建 Activity中的 mBase ContextImpl 对象</span>
                CharSequence title <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span><span class="token function">loadLabel</span><span class="token punctuation">(</span>appContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Configuration config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>mCompatConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>overrideConfig <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    config<span class="token punctuation">.</span><span class="token function">updateFrom</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>overrideConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_CONFIGURATION<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Launching activity "</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" with config "</span> <span class="token operator">+</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Window window <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>mPreserveWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    window <span class="token operator">=</span> r<span class="token punctuation">.</span>mPendingRemoveWindow<span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>mPendingRemoveWindow <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>mPendingRemoveWindowManager <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 初始化Activity</span>
                activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>customIntent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activity<span class="token punctuation">.</span>mIntent <span class="token operator">=</span> customIntent<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>lastNonConfigurationInstances <span class="token operator">=</span> null<span class="token punctuation">;</span>
                activity<span class="token punctuation">.</span>mStartedActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> theme <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span><span class="token function">getThemeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>theme <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    activity<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                activity<span class="token punctuation">.</span>mCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//调用Activity的 onCreate方法</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">,</span> r<span class="token punctuation">.</span>persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>首先通过反射创建了一个 Activity ，其次创建该 Activity 包装的 ContextImpl 对象（ Activity 是一个 Context 的包装类，真正与系统资源打交道的是其包装的 ContextImpl 对象 mBase），然后通过<code>activity.attach</code>的函数传入参数初始化Activity,最后调用<code>mInstrumentation.callActivityOnCreate</code>执行到 Activity 的 onCreate 方法中，至此 Activity 整体启动流程已经走完，不过还有一个前面留下的问题，我们在这里又见到了 mInstrumentation 对象，ActivityThread 中大多操作都要倚仗它来执行，好比一个管家，跟踪它的引用可以知道它是在应用进程被创建后 BindApplication 中被创建和初始化的，一个主线程 ActivityThread 中只有一个 mInstrumentation，Activity 中 mInstrumentation 也就是主线程中的 mInstrumentation 的，其负责对内事务，而对外交流则交给 ActivityThread 负责，最后引用一张图来简述整个流程： </p>
<p><img src="/img/start_activity_process.jpg" alt=""></p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>谢谢阅读，文中如有错误欢迎交流沟通，五一快乐！<br>Thanks:</p>
<p><a href="http://weishu.me/2016/01/12/binder-index-for-newer/" target="_blank" rel="noopener">田维术大神的 Binder 学习指南</a><br><a href="">Android 开发艺术探索</a><br><a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">Binder 设计与实现</a><br><a href="https://blog.csdn.net/Luoshengyang" target="_blank" rel="noopener">老罗的博客</a><br><a href="http://gityuan.com/" target="_blank" rel="noopener">gityuan的博客</a>  </p>
<p><img src="/img/429.jpg" alt=""></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/12/09/growth/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/03/20/briefpreference/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="Ethan Hua's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        65351871@qq.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/12/">十二月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/04/">四月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/03/">三月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">二月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android/">Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Arithmetic/">Arithmetic<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Jvm/">Jvm<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/RxJava-Android/">RxJava/Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/UI-Android/">UI/Android<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/架构组件-Android/">架构组件/Android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/语言基础/">语言基础<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/进程通信-Linux/">进程通信/Linux<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/随笔/">随笔<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/音视频-Android/">音视频/Android<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">18</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/ethanhua" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Ethanhua's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
